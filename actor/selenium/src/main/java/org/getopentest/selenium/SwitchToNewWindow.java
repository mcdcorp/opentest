package org.getopentest.selenium;

import org.getopentest.selenium.core.SeleniumTestAction;
import java.util.ArrayList;

import org.getopentest.logging.Logger;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.Keys;

/*Keyword to open new tab or switch between existing tabs*/
public class SwitchToNewWindow extends SeleniumTestAction {
    @Override
    public void run() {
        super.run();

        String newURL = this.readStringArgument("newURL", null);
        String tabOperation = this.readStringArgument("tabOperation", null);
        String tabNumber = this.readStringArgument("tabNumber", null);
        

        String[] windowHandles = driver.getWindowHandles().stream()
                .toArray(String[]::new);
        try {
            	switch (tabOperation) {
                case "newTab":
                	((JavascriptExecutor) driver).executeScript("window.open(arguments[0])", newURL); 
                	driver.switchTo().defaultContent();
                	break;
                case "previousTab":
                	driver.switchTo().window(driver.getWindowHandle());
                    driver.findElement(By.cssSelector("body")).sendKeys(Keys.CONTROL +"\t");
                    driver.switchTo().defaultContent();
                	break;
                case "otherTab":               	
                	ArrayList<String> tabs = new ArrayList<String> (driver.getWindowHandles());
                	driver.switchTo().window(tabs.get(Integer.parseInt(tabNumber)));
                	break;	
                case "closeTab":
                	driver.close();
                	break;
                default:
                    throw new RuntimeException(String.format(
                            "Issue while handling current tab operation",
                            tabOperation));	
            	}
            
            Logger.info(String.format(
                    "Successfully switched to new window",
                    newURL));
            
        } catch (Exception ex) {
            throw new RuntimeException(String.format(
                    "Failed to switch new window.",
                    newURL,
                    windowHandles.length), ex);
        }
    }
}
