package org.getopentest.appium;

import io.appium.java_client.MobileElement;
import io.appium.java_client.touch.offset.PointOption;
import org.getopentest.appium.core.AppiumTestAction;
import org.openqa.selenium.By;
import org.openqa.selenium.Dimension;
import org.openqa.selenium.Point;

public class ActionsMoveTo extends AppiumTestAction {

    @Override
    public void run() {
        super.run();

        By locator = this.readLocatorArgument("locator", null);
        Integer xOffset = this.readIntArgument("xOffset", null);
        Integer yOffset = this.readIntArgument("yOffset", null);
        Integer x = this.readIntArgument("x", null);
        Integer y = this.readIntArgument("y", null);

        if (locator != null) {
            MobileElement element = this.getElement(locator);
            Point position = element.getLocation();
            Dimension dimension = element.getSize();

            int xCoord = 0;
            int yCoord = 0;

            if (xOffset == null && yOffset == null) {
                // When xOffset and yOffset are not present, we move to
                // the center of the element
                xCoord = position.x + (dimension.width / 2);
                yCoord = position.y + (dimension.height / 2);
            } else {
                // When xOffset and/or yOffset are specified, we calculate the
                // coordinates based on the top left corner of the element
                xOffset = xOffset == null ? 0 : xOffset;
                yOffset = yOffset == null ? 0 : yOffset;
               
                xCoord = position.x + xOffset;
                yCoord = position.y + yOffset;
            }

            AppiumTestAction.getActionsInstance()
                    .moveTo(PointOption.point(xCoord, yCoord));
        } else if (x != null || y != null) {
            AppiumTestAction.getActionsInstance()
                    .moveTo(PointOption.point(x, y));
        } else {
            throw new RuntimeException(
                    "You must provide the locator of a UI element or the "
                    + "x and y coordinates of the point to move to.");
        }
    }
}
