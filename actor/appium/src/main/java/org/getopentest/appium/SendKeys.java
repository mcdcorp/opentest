package org.getopentest.appium;

import org.getopentest.appium.core.SwipingAction;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;

public class SendKeys extends SwipingAction {

    @Override
    public void run() {
        super.run();

        By locator = this.readLocatorArgument("locator", null);
        String text = this.readStringArgument("text");
        Boolean clearContent = this.readBooleanArgument("clearContent", this.readBooleanArgument("clear", Boolean.FALSE));
        Boolean hideKeyboard = this.readBooleanArgument("hideKeyboard", true);
        Boolean useKeyboardService = this.readBooleanArgument("useKeyboardService", Boolean.FALSE);
        Boolean sendToActiveElement = this.readBooleanArgument("sendToActiveElement", Boolean.FALSE);

        try {
            WebElement element = null;

            if (locator != null) {
                this.swipeAndCheckElementVisible(locator, this.getSwipeOptions());
                element = this.getElement(locator);
            } else if (sendToActiveElement) {
                try {
                    element = driver.switchTo().activeElement();
                } catch (Exception exc) {
                    throw new RuntimeException(
                            "We failed to retrieve the active element. Before using the \"sendToActiveElement\" argument, "
                            + "please make sure to tap the element (or perform the steps necessary to make it active).");
                }
            }

            if (clearContent && element != null) {
                element.clear();
            }

            if (useKeyboardService) {
                driver.getKeyboard().sendKeys(text);
            } else {
                if (element != null) {
                    element.sendKeys(text);
                } else {
                    throw new RuntimeException(
                            "Can't perform action. You must either specify the locator of the element to send "
                            + "the keys to, or set one of the \"sendToActiveElement\" or \"useKeyboardService\" "
                            + "arguments to true.");
                }
            }

            if (hideKeyboard) {
                this.hideKeyboard();
            }
        } catch (Exception ex) {
            if (locator != null) {
                throw new RuntimeException(String.format(
                        "Failed sending keys \"%s\" to element %s",
                        text,
                        locator.toString()), ex);
            } else {
                throw new RuntimeException(String.format(
                        "Failed sending keys \"%s\"",
                        text), ex);
            }
        }
    }
}
